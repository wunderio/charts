suite: Site ingress
templates:
  - ingress.yaml
tests:
  - it: is a ingress
    template: ingress.yaml
    asserts:
      - isKind:
          of: Ingress

  - it: uses traefik ingress class
    template: ingress.yaml
    asserts:
      - equal:
          path: 'metadata.annotations.kubernetes\.io/ingress\.class'
          value: 'traefik'

  - it: sets correct hostname for deployment
    template: ingress.yaml
    set:
      environmentName: 'foo'
      projectName: 'bar' 
      clusterDomain: 'baz' 
    asserts:
      - equal:
          path: spec.rules[0].host
          value: 'foo.bar.baz'
  
  - it: sets correct hostname for deployment when projectName is absent
    template: ingress.yaml
    set:
      environmentName: 'foo'
      clusterDomain: 'baz' 
    asserts:
      - equal:
          path: spec.rules[0].host
          value: 'foo.namespace.baz'

  - it: directs traefik requests to nginx service by default
    template: ingress.yaml
    asserts:
      - equal:
          path: spec.rules[0].http.paths[0].backend.serviceName
          value: 'RELEASE-NAME-nginx'

  - it: shortens long project names
    template: ingress.yaml
    set:
      projectName: 'client-fi-longclient-longproject-backend'
    asserts:
      - equal:
          path: spec.rules[0].host
          value: 'release-name.client-fi-longclient-longpra6b.silta.wdr.io'

  - it: shortens long branch names
    template: ingress.yaml
    set:
      environmentName: 'feature/my-project-shortname-12345-with-additional-description'
    asserts:
      - equal:
          path: spec.rules[0].host
          value: 'feature-my-project-shortname-12345-witdb6.namespace.silta.wdr.io'

  - it: shortens branch names more when project name is already long
    template: ingress.yaml
    set:
      projectName: 'client-fi-longclient-longproject-backend'
      environmentName: 'feature/my-project-shortname-12345-with-additional-description'
    asserts:
      - equal:
          path: spec.rules[0].host
          value: 'feature-my-projecdb6.client-fi-longclient-longpra6b.silta.wdr.io'

  - it: takes a hostname prefix
    template: ingress.yaml
    set:
      domainPrefixes: ['qux', 'quux']
      environmentName: 'foo'
      projectName: 'bar'
      clusterDomain: 'baz'
    asserts:
      - equal:
          path: spec.rules[0].host
          value: 'foo.bar.baz'
      - equal:
         path: spec.rules[1].host
         value: 'qux.foo.bar.baz'
      - equal:
         path: spec.rules[2].host
         value: 'quux.foo.bar.baz'
